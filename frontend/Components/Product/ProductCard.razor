@namespace frontend.Components.Product
@using frontend.Utils
@using frontend.Components.UI

@code {
    [Parameter]
    public ShoppingItem? Product { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public EventCallback<string> OnAddToCart { get; set; }

    [Parameter]
    public EventCallback<string> OnRemoveFromCart { get; set; }

    [Parameter]
    public EventCallback<string> OnProductClick { get; set; }

    private string _imageSrc = string.Empty;
    private bool _imageError;

    protected override void OnInitialized()
    {
        _imageSrc = Product?.ImageUrl ?? "/images/placeholder.png";
    }

    private void HandleImageError()
    {
        if (!_imageError)
        {
            _imageError = true;
            _imageSrc = "/images/placeholder.png";
        }
    }

    private async Task HandleCardClick()
    {
        if (Product != null)
        {
            await OnProductClick.InvokeAsync(Product.Id);
        }
    }

    private async Task HandleAddToCart(string productId)
    {
        await OnAddToCart.InvokeAsync(productId);
    }

    private async Task HandleRemoveFromCart(string productId)
    {
        await OnRemoveFromCart.InvokeAsync(productId);
    }
}

@if (Product != null)
{
    <div 
        class="min-w-[16rem] text-gray-600 border-2 border-dashed border-orange-300/50 bg-orange-50 shadow-none transition-transform duration-100 cursor-pointer hover:scale-105 rounded-lg @Class"
        @onclick="HandleCardClick"
    >
        <div>
            <img
                src="@_imageSrc"
                alt="@(Product.ImageAlt ?? "placeholder")"
                @onerror="HandleImageError"
                class="w-full h-40 object-cover rounded-t-lg"
                style="width: 100%; height: 160px; object-fit: cover;"
            />
            <div class="p-3 rounded-b-lg">
                <h3 class="font-semibold">@Product.ProductName</h3>
                <p class="text-sm text-gray-500 mb-2">by @Product.SellerName</p>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-base text-orange-400">@FormatUtils.FormatCurrency(Product.Price)</span>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span class="text-sm text-gray-500">@Product.Rating.ToString("0.0")</span>
                    </div>
                </div>
                <AddToCartButton 
                    ProductId="@Product.Id"
                    IsAddedToCart="@Product.IsAddedToCart"
                    OnAddToCart="HandleAddToCart"
                    OnRemoveFromCart="HandleRemoveFromCart"
                />
            </div>
        </div>
    </div>
}
