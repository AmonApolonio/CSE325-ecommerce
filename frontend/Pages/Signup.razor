@layout NoLayout

@page "/signup"
@using System.Net.Http.Json
@using frontend.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Signup - SharpCraft Shop</PageTitle>

<div class="min-h-screen bg-white flex items-center justify-center py-12 px-4">
    <div class="w-full max-w-md">
        <div class="bg-orange-50 border-2 border-orange-300/50 rounded-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">SharpCraft Shop</h1>
            <p class="text-gray-600 text-center mb-8">Create your account</p>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="mb-4 p-3 @((isSuccessMessage ? "bg-green-100 border-l-4 border-green-500 text-green-700" : "bg-red-100 border-l-4 border-red-500 text-red-700"))">
                    <p class="font-semibold">@(isSuccessMessage ? "Success" : "Error")</p>
                    <p>@message</p>
                </div>
            }

            <EditForm EditContext="@editContext" OnValidSubmit="RegisterUser">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="space-y-4">
                    <!-- User Type -->
                    <div>
                        <label class="block text-sm text-gray-600 font-semibold mb-2">User Type</label>
                        <select class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50"
                                @bind="UserType">
                            <option value="">Select...</option>
                            <option value="Client">Client</option>
                            <option value="Seller">Seller</option>
                        </select>
                    </div>

                    @if (UserType == "Client")
                    {
                        <!-- Client Fields -->
                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Name</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Name" />
                            <ValidationMessage For="@(() => client.Name)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Email</label>
                            <InputText type="email" class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Email" />
                            <ValidationMessage For="@(() => client.Email)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Password</label>
                            <div class="relative">
                                <InputText type="@(showPassword ? "text" : "password")" class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50 pr-10" @bind-Value="client.PasswordHash" />
                                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" @onclick="() => showPassword = !showPassword">
                                    <i class="@(showPassword ? "fas fa-eye-slash" : "fas fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => client.PasswordHash)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Confirm Password</label>
                            <div class="relative">
                                <InputText type="@(showConfirmPassword ? "text" : "password")" class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50 pr-10" @bind-Value="confirmPassword" />
                                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" @onclick="() => showConfirmPassword = !showConfirmPassword">
                                    <i class="@(showConfirmPassword ? "fas fa-eye-slash" : "fas fa-eye")"></i>
                                </button>
                            </div>
                        </div>

<!--
                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Phone Number</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.PhoneNumber" />
                            <ValidationMessage For="@(() => client.PhoneNumber)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Address 1</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Address1" />
                            <ValidationMessage For="@(() => client.Address1)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Address 2</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Address2" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">City</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.City" />
                            <ValidationMessage For="@(() => client.City)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">State</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.State" />
                            <ValidationMessage For="@(() => client.State)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Country</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Country" />
                            <ValidationMessage For="@(() => client.Country)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Zip Code</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.ZipCode" />
                            <ValidationMessage For="@(() => client.ZipCode)" />
                        </div>
-->
                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Address 1</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Address1" />
                            <ValidationMessage For="@(() => client.Address1)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">City</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.City" />
                            <ValidationMessage For="@(() => client.City)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">State</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.State" />
                            <ValidationMessage For="@(() => client.State)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Country</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="client.Country" />
                            <ValidationMessage For="@(() => client.Country)" />
                        </div>
                    }
                    else if (UserType == "Seller")
                    {
                        <!-- Seller Fields -->
                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Name</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Name" />
                            <ValidationMessage For="@(() => seller.Name)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Email</label>
                            <InputText type="email" class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Email" />
                            <ValidationMessage For="@(() => seller.Email)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Password</label>
                            <div class="relative">
                                <InputText type="@(showPassword ? "text" : "password")" class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50 pr-10" @bind-Value="seller.PasswordHash" />
                                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" @onclick="() => showPassword = !showPassword">
                                    <i class="@(showPassword ? "fas fa-eye-slash" : "fas fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => seller.PasswordHash)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Confirm Password</label>
                            <div class="relative">
                                <InputText type="@(showConfirmPassword ? "text" : "password")" class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50 pr-10" @bind-Value="confirmPassword" />
                                <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" @onclick="() => showConfirmPassword = !showConfirmPassword">
                                    <i class="@(showConfirmPassword ? "fas fa-eye-slash" : "fas fa-eye")"></i>
                                </button>
                            </div>
                        </div>

<!--
                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Phone Number</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.PhoneNumber" />
                            <ValidationMessage For="@(() => seller.PhoneNumber)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">About Me</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.AboutMe" />
                            <ValidationMessage For="@(() => seller.AboutMe)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Address 1</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Address1" />
                            <ValidationMessage For="@(() => seller.Address1)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Address 2</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Address2" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">City</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.City" />
                            <ValidationMessage For="@(() => seller.City)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">State</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.State" />
                            <ValidationMessage For="@(() => seller.State)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Country</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Country" />
                            <ValidationMessage For="@(() => seller.Country)" />
                        </div>
-->
                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Address 1</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Address1" />
                            <ValidationMessage For="@(() => seller.Address1)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">City</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.City" />
                            <ValidationMessage For="@(() => seller.City)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">State</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.State" />
                            <ValidationMessage For="@(() => seller.State)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Country</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.Country" />
                            <ValidationMessage For="@(() => seller.Country)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Photo (URL)</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.PhotoUrl" />
                            <ValidationMessage For="@(() => seller.PhotoUrl)" />
                        </div>

                        <div>
                            <label class="block text-sm text-gray-600 font-semibold mb-2">Zip Code</label>
                            <InputText class="w-full px-4 py-2 rounded-lg border-2 border-orange-300 focus:outline-none focus:ring-2 focus:ring-orange-300/50" @bind-Value="seller.ZipCode" />
                            <ValidationMessage For="@(() => seller.ZipCode)" />
                        </div>
                    }

                    <!-- Signup Button -->
                    <button class="w-full py-3 px-4 bg-orange-400 text-white font-semibold rounded-lg hover:bg-orange-500 transition" type="submit">
                        <i class="fas fa-user-plus mr-2"></i>Create Account
                    </button>
                </div>
            </EditForm>

            <div class="mt-6 text-center">
                <p class="text-gray-600 mb-4">Already have an account?</p>
                <a href="login" class="inline-block px-6 py-2 border-2 border-orange-400 text-orange-400 font-semibold rounded-lg hover:bg-orange-50 transition">
                    Sign In
                </a>
            </div>
        </div>
    </div>
</div>

@code {
    private string _userType = "";
    private Client client = new();
    private Seller seller = new();
    private object? currentUser;
    private EditContext? editContext;
    private string message = "";
    private bool isSuccessMessage = false;

    private string UserType
    {
        get => _userType;
        set
        {
            _userType = value;
            currentUser = _userType == "Client" ? client : seller;
            editContext = new EditContext(currentUser);
        }
    }

    protected override void OnInitialized()
    {
        currentUser = client; // Default model
        editContext = new EditContext(currentUser);
    }

    private async Task RegisterUser()
    {
        HttpResponseMessage response;
        if (UserType == "Client")
        {
            var clientData = new
            {
                client.Name,
                client.Email,
                client.PasswordHash,
                client.Address1,
                client.City,
                client.State,
                client.Country
            };
            response = await Http.PostAsJsonAsync("api/Clients", clientData);
        }
        else if (UserType == "Seller")
        {
            var sellerData = new
            {
                seller.Name,
                seller.Email,
                seller.PasswordHash,
                seller.Address1,
                seller.City,
                seller.State,
                seller.Country,
                seller.PhotoUrl,
                seller.ZipCode
            };
            response = await Http.PostAsJsonAsync("api/Sellers", sellerData);
        }
        else
        {
            message = "Please select a user type.";
            isSuccessMessage = false;
            return;
        }

        if (response.IsSuccessStatusCode)
        {
            message = $"{UserType} registered successfully!";
            isSuccessMessage = true;
            // Redirect to login after a short delay or immediately
            await Task.Delay(2000); // Optional delay to show message
            NavigationManager.NavigateTo("login");
        }
        else
        {
            message = $"Error registering {UserType}.";
            isSuccessMessage = false;
        }
    }

    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private string confirmPassword = "";
}