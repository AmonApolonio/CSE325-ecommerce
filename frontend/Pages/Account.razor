@page "/account"

@using Microsoft.JSInterop
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@inject IHttpClientFactory ClientFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Components.Forms
@using frontend.Services
@using frontend.Models.Dtos
@inject IProductService ProductService
@inject ICategoryService CategoryService



<PageTitle>My Account - SharpCraft Shop</PageTitle>

@code {

    private bool _isLoading = true;
    private string _role = string.Empty;
    private string _message = string.Empty; // Mensagem de feedback
    private bool _isError = false;
    private string _activeTab = "profile"; // New: track active tab
    private List<ProductDto> _sellerProducts = new(); // New: for seller products
    private bool _productsLoading = false; // New: loading state for products
    private bool _showAddProductModal = false; // New: for add product modal
    private ProductDto _newProduct = new(); // New: for new product form
    private List<CategoryDto> _categories = new(); // New: for categories dropdown
    private bool _showEditProductModal = false; // New: for edit product modal
    private ProductDto _editingProduct = new(); // New: for editing product
    private bool _showDeleteConfirmation = false; // New: for delete confirmation
    private ProductDto _productToDelete = new(); // New: product pending deletion

    private ClientProfile _client = new();
    private SellerProfile _seller = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var email = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userEmail");
            _role = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole");

            // =================================================================
            // CORREÇÃO: Verifica se o usuário está logado. Se não estiver, redireciona.
            // Usamos 'forceLoad: true' para garantir que o navegador force um
            // novo carregamento da página de login, contornando problemas de ciclo
            // de vida do Blazor.
            // =================================================================
            if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(_role))
            {
                // Redireciona para a página de login, forçando o carregamento total
                NavigationManager.NavigateTo("login", forceLoad: true);
                return; // Para a execução do restante da função, pois o usuário não está autenticado
            }
            // =================================================================

            // Se a execução chegou até aqui, o usuário está logado. Procede com o carregamento do perfil.
            var httpClient = ClientFactory.CreateClient("BackendApi");

            if (_role == "Client")
            {
                var response = await httpClient.GetAsync($"api/Clients/by-email/{email}");
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ClientProfile>();
                    if(result != null) _client = result;
                }
            }
            else if (_role == "Seller")
            {
                var response = await httpClient.GetAsync($"api/Sellers/by-email/{email}");
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<SellerProfile>();
                    if(result != null) _seller = result;
                }
                // Load categories for the add product modal
                _categories = await CategoryService.GetAllCategoriesAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro: {ex.Message}");
        }

        _isLoading = false;
    }

    // =================================================================
    // Função para tratar o Logout
    // =================================================================
    private void HandleLogout()
    {
        // Redireciona para o componente de Logout, onde a lógica de limpeza do localStorage e
        // atualização do AuthStateProvider está contida.
        NavigationManager.NavigateTo("logout");
    }


    // =================================================================
    // SaveSeller function (AJUSTADA PARA USAR DTO)
    // =================================================================
    private async Task SaveSeller()
    {
        try
        {
            var httpClient = ClientFactory.CreateClient("BackendApi");
            
            // 1. Mapear o _seller (modelo do formulário) para o DTO de detalhes
            var updateDto = new SellerDetailsDto
            {
                SellerId = _seller.SellerId, 
                Name = _seller.Name,
                PhotoUrl = _seller.PhotoUrl,
                AboutMe = _seller.AboutMe,
                PhoneNumber = _seller.PhoneNumber,
                Address1 = _seller.Address1,
                Address2 = _seller.Address2,
                City = _seller.City,
                State = _seller.State,
                Country = _seller.Country,
                ZipCode = _seller.ZipCode
            };

            // 2. Chamar o ENDPOINT específico para detalhes, enviando o DTO
            // PUT: api/Sellers/details/{id}
            var response = await httpClient.PutAsJsonAsync($"api/Sellers/details/{_seller.SellerId}", updateDto);

            if (response.IsSuccessStatusCode)
            {
                ShowMessage("Store profile updated successfully!", false);
            }
            else
            {
                
                var errorContent = await response.Content.ReadAsStringAsync();
                ShowMessage($"Failed to update store profile. Status code: {response.StatusCode}. Details: {errorContent}", true);
            }
        }
        catch (Exception)
        {
            ShowMessage("An error occurred while saving the store profile.", true);
        }
    }
    
    private void ShowMessage(string msg, bool isError)
    {
        _message = msg;
        _isError = isError;

        // Use InvokeAsync para garantir que a atualização da interface (StateHasChanged)
        // ocorra no contexto de sincronização correto do Blazor (UI thread).
        InvokeAsync(() =>
        {
            // 1. Força a UI a mostrar a mensagem imediatamente
            StateHasChanged(); 
            
            // 2. Agenda a limpeza da mensagem após 3 segundos
            Task.Delay(3000).ContinueWith(_ => 
            { 
                _message = string.Empty; 
                // 3. Garante que a limpeza também atualize a UI (já está correta)
                InvokeAsync(StateHasChanged); 
            });
        });
    }

    // =================================================================
    // Load Seller Products
    // =================================================================
    private async Task LoadSellerProducts()
    {
        if (_role != "Seller" || _seller.SellerId == 0) return;

        _productsLoading = true;
        try
        {
            _sellerProducts = await ProductService.GetProductsAsync(sellerId: _seller.SellerId);
        }
        catch (Exception ex)
        {
            ShowMessage($"Error loading products: {ex.Message}", true);
        }
        finally
        {
            _productsLoading = false;
            StateHasChanged();
        }
    }

    // =================================================================
    // Handle Tab Change
    // =================================================================
    private async Task SetActiveTab(string tab)
    {
        _activeTab = tab;
        if (tab == "products" && _sellerProducts.Count == 0)
        {
            await LoadSellerProducts();
        }
        StateHasChanged();
    }

    // =================================================================
    // Open Add Product Modal
    // =================================================================
    private void OpenAddProductModal()
    {
        _newProduct = new ProductDto 
        { 
            SellerId = _seller.SellerId,
            CartItems = new List<CartItemDto>(),
            OrdersProducts = new List<OrdersProductDto>(),
            Seller = null
        };
        // Set default category if available
        if (_categories.Any())
        {
            _newProduct.CategoryId = _categories.First().CategoryId;
        }
        _showAddProductModal = true;
        StateHasChanged();
    }

    // =================================================================
    // Close Add Product Modal
    // =================================================================
    private void CloseAddProductModal()
    {
        _showAddProductModal = false;
        _newProduct = new ProductDto();
        StateHasChanged();
    }

    // =================================================================
    // Add New Product
    // =================================================================
    private async Task AddNewProduct()
    {
        try
        {
            // Convert price from dollars to cents
            _newProduct.Price = (int)(_newProduct.Price);
            await ProductService.CreateProductAsync(_newProduct);
            ShowMessage("Product added successfully!", false);
            CloseAddProductModal();
            await LoadSellerProducts(); // Refresh the list
        }
        catch (Exception ex)
        {
            ShowMessage($"Error adding product: {ex.Message}", true);
        }
    }

    // =================================================================
    // Open Edit Product Modal
    // =================================================================
    private void OpenEditProductModal(ProductDto product)
    {
        _editingProduct = new ProductDto
        {
            ProductId = product.ProductId,
            Name = product.Name,
            Description = product.Description,
            Price = product.Price,
            Inventory = product.Inventory,
            CategoryId = product.CategoryId,
            SellerId = product.SellerId,
            Url = product.Url,
            CartItems = product.CartItems,
            OrdersProducts = product.OrdersProducts,
            Seller = product.Seller
        };
        _showEditProductModal = true;
        StateHasChanged();
    }

    // =================================================================
    // Close Edit Product Modal
    // =================================================================
    private void CloseEditProductModal()
    {
        _showEditProductModal = false;
        _editingProduct = new ProductDto();
        StateHasChanged();
    }

    // =================================================================
    // Save Edited Product
    // =================================================================
    private async Task SaveEditedProduct()
    {
        try
        {
            // Convert price from dollars to cents 
            _editingProduct.Price = (int)(_editingProduct.Price);
            await ProductService.UpdateProductAsync(_editingProduct.ProductId, _editingProduct);
            ShowMessage("Product updated successfully!", false);
            CloseEditProductModal();
            await LoadSellerProducts(); // Refresh the list
        }
        catch (Exception ex)
        {
            ShowMessage($"Error updating product: {ex.Message}", true);
        }
    }

    // =================================================================
    // Open Delete Confirmation Dialog
    // =================================================================
    private void OpenDeleteConfirmation(ProductDto product)
    {
        _productToDelete = product;
        _showDeleteConfirmation = true;
        StateHasChanged();
    }

    // =================================================================
    // Close Delete Confirmation Dialog
    // =================================================================
    private void CloseDeleteConfirmation()
    {
        _showDeleteConfirmation = false;
        _productToDelete = new ProductDto();
        StateHasChanged();
    }

    // =================================================================
    // Confirm and Delete Product
    // =================================================================
    private async Task ConfirmDeleteProduct()
    {
        try
        {
            await ProductService.DeleteProductAsync(_productToDelete.ProductId);
            ShowMessage("Product deleted successfully!", false);
            CloseDeleteConfirmation();
            await LoadSellerProducts(); // Refresh the list
        }
        catch (Exception ex)
        {
            ShowMessage($"Error deleting product: {ex.Message}", true);
        }
    }

    public class ClientProfile
    {
        public long UserId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string Address1 { get; set; } = string.Empty;
        public string Address2 { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string ZipCode { get; set; } = string.Empty;
    }

    public class SellerProfile
    {
        public long SellerId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string PhotoUrl { get; set; } = string.Empty;
        public string AboutMe { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string Address1 { get; set; } = string.Empty;
        public string Address2 { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string ZipCode { get; set; } = string.Empty;
    }
    
    // =================================================================
    // DTO for the Client PUT (MUST MATCH THE DTO IN THE BACKEND)
    // =================================================================
    public class ClientDetailsDto
    {
        public long UserId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public string Address1 { get; set; } = string.Empty;
        public string Address2 { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string ZipCode { get; set; } = string.Empty;
    }

    // =================================================================
    // DTO for the Seller PUT (ADICIONADO)
    // =================================================================
    public class SellerDetailsDto
    {
        public long SellerId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string PhotoUrl { get; set; } = string.Empty;
        public string? AboutMe { get; set; } // Permitindo que seja opcional
        public string? PhoneNumber { get; set; }
        public string Address1 { get; set; } = string.Empty;
        public string? Address2 { get; set; }
        public string City { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string ZipCode { get; set; } = string.Empty;
        // Email, CommisionRate e PasswordHash foram omitidos, pois não devem ser alterados aqui.
    }
    
    // =================================================================
    // SaveClient function
    // =================================================================
    private async Task SaveClient()
    {
        try
        {
            var httpClient = ClientFactory.CreateClient("BackendApi");
            
            // 1. Mapear o _client (modelo do formulário) para o DTO de detalhes
            // Isso garante que não estamos enviando 'PasswordHash' ou 'Carts'
            var updateDto = new ClientDetailsDto
            {
                UserId = _client.UserId, // ID é crucial para a rota
                Name = _client.Name,
                Email = _client.Email, // Mesmo sendo readonly no form, o DTO espera
                PhoneNumber = _client.PhoneNumber,
                Address1 = _client.Address1,
                Address2 = _client.Address2,
                City = _client.City,
                State = _client.State,
                Country = _client.Country,
                ZipCode = _client.ZipCode
            };

            // 2. Chamar o NOVO ENDPOINT específico para detalhes
            // PUT: api/Clients/details/{id}
            var response = await httpClient.PutAsJsonAsync($"api/Clients/details/{_client.UserId}", updateDto);

            if (response.IsSuccessStatusCode)
            {
                ShowMessage("Profile updated successfully!", false);
            }
            else
            {
                // Tenta ler a mensagem de erro detalhada da API (útil para 400 Bad Request)
                var errorContent = await response.Content.ReadAsStringAsync();
                ShowMessage($"Failed to update profile. Status code: {response.StatusCode}. Details: {errorContent}", true);
            }
        }
        catch (Exception)
        {
            ShowMessage("An error occurred while saving.", true);
        }
    }
}


<div class="bg-white min-h-screen">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">My Account</h1>

    @if (_isLoading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                <div class="bg-orange-50 border-2 border-orange-300/50 rounded-lg overflow-hidden flex flex-col">
                    <a href="javascript:void(0);" @onclick="@(() => SetActiveTab("profile"))" class="p-3 @(_activeTab == "profile" ? "bg-orange-200" : "hover:bg-orange-100") text-gray-800 font-bold cursor-pointer">
                        <i class="fas fa-user mr-2"></i>Profile
                    </a>
                    @if (_role == "Seller")
                    {
                        <a href="javascript:void(0);" @onclick="@(() => SetActiveTab("products"))" class="p-3 @(_activeTab == "products" ? "bg-orange-200" : "hover:bg-orange-100") text-gray-700 cursor-pointer">
                            <i class="fas fa-box mr-2"></i>My Products
                        </a>
                    }
                    <a href="javascript:void(0);" @onclick="HandleLogout" class="p-3 hover:bg-orange-100 text-gray-700 cursor-pointer">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>

            <div class="md:col-span-2">
                @if (_activeTab == "profile")
                {
                    <div class="bg-orange-50 border-2 border-orange-300/50 rounded-lg p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Edit Profile</h2>
                            @if (!string.IsNullOrEmpty(_message))
                            {
                                <span class="@(_isError ? "text-red-600" : "text-green-600") font-bold px-4 py-2 bg-white rounded shadow">
                                    @_message
                                </span>
                            }
                        </div>

                        @if (_role == "Client")
                        {
                            <EditForm Model="_client" OnValidSubmit="SaveClient">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name</label>
                                        <InputText @bind-Value="_client.Name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Email (Read Only)</label>
                                        <InputText @bind-Value="_client.Email" disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Phone</label>
                                        <InputText @bind-Value="_client.PhoneNumber" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="col-span-2">
                                            <label class="block text-sm font-medium text-gray-700">Address 1</label>
                                            <InputText @bind-Value="_client.Address1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div class="col-span-2">
                                            <label class="block text-sm font-medium text-gray-700">Address 2</label>
                                            <InputText @bind-Value="_client.Address2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">City</label>
                                            <InputText @bind-Value="_client.City" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">State</label>
                                            <InputText @bind-Value="_client.State" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Country</label>
                                            <InputText @bind-Value="_client.Country" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Zip Code</label>
                                            <InputText @bind-Value="_client.ZipCode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition">
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </EditForm>
                        }
                        else if (_role == "Seller")
                        {
                            <EditForm Model="_seller" OnValidSubmit="SaveSeller">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                <div class="grid grid-cols-1 gap-4">
                                    <div class="flex items-center gap-4">
                                        @if (!string.IsNullOrEmpty(_seller.PhotoUrl))
                                        {
                                            <img src="@_seller.PhotoUrl" alt="Profile" class="w-20 h-20 rounded-full object-cover" />
                                        }
                                        <div class="flex-grow">
                                            <label class="block text-sm font-medium text-gray-700">Photo URL</label>
                                            <InputText @bind-Value="_seller.PhotoUrl" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Name (Store Name)</label>
                                        <InputText @bind-Value="_seller.Name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Email (Read Only)</label>
                                        <InputText @bind-Value="_seller.Email" disabled class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">About Me / Store Description</label>
                                        <InputTextArea @bind-Value="_seller.AboutMe" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 h-24" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Phone</label>
                                        <InputText @bind-Value="_seller.PhoneNumber" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="col-span-2">
                                            <label class="block text-sm font-medium text-gray-700">Address 1</label>
                                            <InputText @bind-Value="_seller.Address1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div class="col-span-2">
                                            <label class="block text-sm font-medium text-gray-700">Address 2</label>
                                            <InputText @bind-Value="_seller.Address2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">City</label>
                                            <InputText @bind-Value="_seller.City" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">State</label>
                                            <InputText @bind-Value="_seller.State" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Country</label>
                                            <InputText @bind-Value="_seller.Country" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Zip Code</label>
                                            <InputText @bind-Value="_seller.ZipCode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" />
                                        </div>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition">
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </EditForm>
                        }
                    </div>
                }
                else if (_activeTab == "products")
                {
                    <div class="bg-orange-50 border-2 border-orange-300/50 rounded-lg p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">My Products</h2>
                            <button @onclick="OpenAddProductModal" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition">
                                <i class="fas fa-plus mr-2"></i>Add New Product
                            </button>
                        </div>

                        @if (_productsLoading)
                        {
                            <div class="flex items-center justify-center py-16">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin text-orange-400 text-4xl mb-4"></i>
                                    <p class="text-gray-600">Loading products...</p>
                                </div>
                            </div>
                        }
                        else if (_sellerProducts.Count == 0)
                        {
                            <div class="text-center py-16">
                                <i class="fas fa-box-open text-gray-300 text-6xl mb-4"></i>
                                <p class="text-gray-600 text-lg">No products found</p>
                            </div>
                        }
                        else
                        {
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                @foreach (var product in _sellerProducts)
                                {
                                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-3">
                                        <div class="mb-3 h-40 bg-gray-100 rounded flex items-center justify-center overflow-hidden">
                                            @if (!string.IsNullOrEmpty(product.Url))
                                            {
                                                <img src="@product.Url" alt="@product.Name" class="w-full h-full object-cover" />
                                            }
                                            else
                                            {
                                                <i class="fas fa-image text-gray-300 text-3xl"></i>
                                            }
                                        </div>
                                        <h3 class="font-semibold text-gray-800 mb-1 text-sm line-clamp-1">@product.Name</h3>
                                        <p class="text-xs text-gray-600 mb-3 line-clamp-2">@product.Description</p>
                                        <div class="mb-3">
                                            <span class="text-lg font-bold text-orange-500">$@product.GetPriceAsDecimal().ToString("F2")</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @onclick="@(() => OpenEditProductModal(product))" class="flex-1 bg-orange-400 hover:bg-orange-500 text-white px-2 py-2 rounded transition-colors text-xs font-semibold">
                                                Edit
                                            </button>
                                            <button @onclick="@(() => OpenDeleteConfirmation(product))" class="bg-red-400 hover:bg-red-500 text-white px-3 py-2 rounded transition-colors" title="Delete product">
                                                <i class="fa-solid fa-trash text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@if (_showAddProductModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Product</h3>
            <EditForm Model="_newProduct" OnValidSubmit="AddNewProduct">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <InputText @bind-Value="_newProduct.Name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <InputTextArea @bind-Value="_newProduct.Description" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 h-24" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price (Cents)</label>
                        <InputNumber @bind-Value="_newProduct.Price" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Inventory</label>
                        <InputNumber @bind-Value="_newProduct.Inventory" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <InputSelect @bind-Value="_newProduct.CategoryId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required>
                            @foreach (var category in _categories)
                            {
                                <option value="@category.CategoryId">@category.Name</option>
                            }
                        </InputSelect>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Image URL</label>
                        <InputText @bind-Value="_newProduct.Url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="https://example.com/image.jpg" />
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" @onclick="CloseAddProductModal" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition">
                        Cancel
                    </button>
                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition">
                        Add Product
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (_showEditProductModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Product</h3>
            <EditForm Model="_editingProduct" OnValidSubmit="SaveEditedProduct">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <InputText @bind-Value="_editingProduct.Name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <InputTextArea @bind-Value="_editingProduct.Description" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 h-24" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price (Cents)</label>
                        <InputNumber @bind-Value="_editingProduct.Price" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Inventory</label>
                        <InputNumber @bind-Value="_editingProduct.Inventory" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <InputSelect @bind-Value="_editingProduct.CategoryId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" required>
                            @foreach (var category in _categories)
                            {
                                <option value="@category.CategoryId">@category.Name</option>
                            }
                        </InputSelect>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Image URL</label>
                        <InputText @bind-Value="_editingProduct.Url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500" placeholder="https://example.com/image.jpg" />
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" @onclick="CloseEditProductModal" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition">
                        Cancel
                    </button>
                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition">
                        Save Changes
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@if (_showDeleteConfirmation)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Delete</h3>
            <p class="text-gray-700 mb-6">
                Are you sure you want to delete <strong>@_productToDelete.Name</strong>? This action cannot be undone.
            </p>
            <div class="flex justify-end space-x-4">
                <button @onclick="CloseDeleteConfirmation" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition">
                    Cancel
                </button>
                <button @onclick="ConfirmDeleteProduct" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition">
                    Delete
                </button>
            </div>
        </div>
    </div>
}
