@page "/cart"
@using frontend.Services
@using frontend.Models.Dtos
@using Microsoft.AspNetCore.Components.Web

@inject ICartService CartService
@inject IProductService ProductService
@inject NavigationManager NavigationManager

<PageTitle>Shopping Cart - SharpCraft Shop</PageTitle>

@code {
    private CartDto? _cart;
    private bool _isLoading = true;
    private string? _errorMessage;
    private Dictionary<long, ProductDto?> _productCache = new();

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        try
        {
            // TODO: Get the actual user ID from authentication service
            // For now, we'll simulate cart loading when cart API endpoints are available
            // _cart = await CartService.GetCartAsync(userId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading cart: {ex.Message}";
            Console.WriteLine(_errorMessage);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task UpdateQuantity(long cartItemId, double newQuantity)
    {
        if (newQuantity < 1)
        {
            await RemoveItem(cartItemId);
        }
        else
        {
            try
            {
                // TODO: Implement when cart API is available
                // await CartService.UpdateCartItemAsync(_cart.CartId, cartItemId, newQuantity);
                // await RefreshCart();
            }
            catch (Exception ex)
            {
                _errorMessage = $"Error updating quantity: {ex.Message}";
            }
        }
    }

    private async Task RemoveItem(long cartItemId)
    {
        try
        {
            // TODO: Implement when cart API is available
            // await CartService.RemoveFromCartAsync(_cart.CartId, cartItemId);
            // await RefreshCart();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error removing item: {ex.Message}";
        }
    }

    private async Task RefreshCart()
    {
        // TODO: Reload cart after making changes
    }

    private void ContinueShopping()
    {
        NavigationManager.NavigateTo("/");
    }

    private void Checkout()
    {
        NavigationManager.NavigateTo("/checkout");
    }

    private decimal GetCartTotal()
    {
        if (_cart?.CartItems == null || _cart.CartItems.Count == 0)
            return 0;

        return _cart.CartItems.Sum(item => 
        {
            // Calculate total per item (price * quantity)
            // Note: Need to fetch price from product or API response
            return 0;
        });
    }
}

<div class="bg-white">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Shopping Cart</h1>

    @if (_isLoading)
    {
        <div class="flex items-center justify-center py-16">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin text-orange-400 text-4xl mb-4"></i>
                <p class="text-gray-600">Loading cart...</p>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4">
            <p class="font-bold">Error</p>
            <p>@_errorMessage</p>
        </div>
    }
    else if (_cart?.CartItems == null || _cart.CartItems.Count == 0)
    {
        <div class="text-center py-16">
            <i class="fas fa-shopping-cart text-gray-300 text-6xl mb-4"></i>
            <p class="text-gray-600 mb-6 text-lg">Your cart is empty</p>
            <button 
                class="inline-flex items-center px-6 py-3 bg-orange-400 text-white rounded-lg hover:bg-orange-500 transition"
                @onclick="ContinueShopping"
            >
                <i class="fas fa-arrow-left mr-2"></i>Continue Shopping
            </button>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            @* Cart Items *@
            <div class="lg:col-span-2">
                <div class="space-y-4">
                    @foreach (var item in _cart.CartItems)
                    {
                        <div class="bg-orange-50 border-2 border-orange-300/50 rounded-lg p-4 flex gap-4">
                            <div class="w-24 h-24 bg-gray-100 rounded flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-image text-gray-300 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800 mb-2">Product #@item.ProductId</h3>
                                <p class="text-gray-600 text-sm mb-3">Quantity: @item.Quantity</p>
                                <button 
                                    class="text-red-500 hover:text-red-700 text-sm font-semibold"
                                    @onclick="@(async () => await RemoveItem(item.CartItemId))"
                                >
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @* Order Summary *@
            <div>
                <div class="bg-orange-50 border-2 border-orange-300/50 rounded-lg p-6 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Order Summary</h2>
                    
                    <div class="space-y-3 mb-6 pb-6 border-b-2 border-orange-300/50">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tax</span>
                            <span class="font-semibold">$0.00</span>
                        </div>
                    </div>

                    <div class="flex justify-between mb-6">
                        <span class="text-lg font-bold text-gray-800">Total</span>
                        <span class="text-2xl font-bold text-orange-400">$0.00</span>
                    </div>

                    <button 
                        class="w-full py-3 px-4 bg-orange-400 text-white font-semibold rounded-lg hover:bg-orange-500 transition mb-3"
                        @onclick="Checkout"
                    >
                        <i class="fas fa-lock mr-2"></i>Proceed to Checkout
                    </button>

                    <button 
                        class="w-full py-3 px-4 border-2 border-orange-400 text-orange-400 font-semibold rounded-lg hover:bg-orange-50 transition"
                        @onclick="ContinueShopping"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>Continue Shopping
                    </button>
                </div>
            </div>
        </div>
    }
</div>
